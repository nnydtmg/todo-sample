# ADR 0009: バックエンドのマルチステージDockerビルド

## ステータス
採用

## コンテキスト
バックエンドアプリケーションをコンテナ化し、簡単にデプロイ・スケーリングできるようにする必要がある。その際、コンテナイメージのサイズやセキュリティ、再現性について検討する必要があった。

## 決定事項
マルチステージビルドを使用したDockerfileを採用し、以下の特徴を持たせる：

1. **ビルドステージとランタイムステージの分離**
   - ビルドステージ: Maven 3.8とJava 17（Alpine）
   - ランタイムステージ: Java 17 JRE（Alpine）

2. **依存関係のキャッシュ最適化**
   - pom.xmlを先にコピーして依存関係を解決
   - ソースコードの変更のみではキャッシュが無効にならない構成

3. **セキュリティ強化**
   - 非rootユーザーで実行
   - 必要最小限のコンポーネントのみをランタイムイメージに含める
   - 適切なヘルスチェックの実装

4. **軽量化**
   - Alpine Linuxベースのイメージ
   - ビルドアーティファクトのみをランタイムイメージにコピー
   - 不要なツール類やソースコードを含めない

## 根拠
- **イメージサイズの削減**: JDKを含む完全なビルド環境は不要。JREのみのランタイムイメージにより、イメージサイズを大幅に削減できる。
- **セキュリティ向上**: 攻撃対象領域を最小化し、非rootユーザーを使用することでセキュリティリスクを低減。
- **ビルド時間の短縮**: 依存関係のキャッシュ最適化により、繰り返しビルド時の時間を短縮。
- **柔軟な環境設定**: 環境変数を通じてプロファイルを設定可能。
- **運用監視の容易さ**: ヘルスチェックによる自動監視を容易に実装可能。

## 影響
- より複雑なDockerfile構造（単一ステージより複雑）
- ビルド環境とランタイム環境が異なるため、潜在的な「ビルドでは動くが本番では動かない」問題の可能性
- Alpine Linuxベースのイメージでの一部ライブラリ互換性の問題が発生する可能性

## 備考
- 将来的にネイティブイメージコンパイル（GraalVM）を検討する場合は、さらなる変更が必要になる可能性がある。
- 本番環境での監視やロギングの要件が明確になれば、Dockerfileをさらに最適化できる。
- 同様のアプローチをフロントエンドにも適用し、nginx静的コンテンツサーバーとしてデプロイ。